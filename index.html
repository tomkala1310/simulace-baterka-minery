<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulace optimalizace FVE pomocí těžby kryptoměn a BESS</title>
  
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js (CDN) - plná verze s Doughnut, Line a Bar grafy -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <style>
    body {
      background-color: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .card {
      background-color: white;
      border-radius: 0.375rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .info-box {
      padding: 0.5rem;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
    }
    .info-label {
      font-size: 0.875rem;
      color: #4b5563;
    }
    .info-value {
      font-size: 1.125rem;
      font-weight: 600;
    }
    .bg-blue-light { background-color: #e0f2fe; }
    .bg-red-light { background-color: #fee2e2; }
    .bg-green-light { background-color: #d1fae5; }
    .bg-yellow-light { background-color: #fef3c7; }
    .bg-orange-light { background-color: #ffedd5; }
    .bg-purple-light { background-color: #f3e8ff; }
    .bg-amber-light { background-color: #fef3c7; }
    .bg-indigo-light { background-color: #e0e7ff; }
    .bg-violet-light { background-color: #ede9fe; }
    
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    .pie-chart-container {
      position: relative;
      height: 200px;
      width: 100%;
    }
    
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="text-xl font-bold">Načítání simulace...</div>
  </div>

  <div id="app" class="p-6 max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Simulace optimalizace FVE pomocí těžby kryptoměn a BESS</h1>
    
    <!-- Grid pro základní informace -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Výroba a spotřeba -->
      <div class="card">
        <h2 class="card-title">Výroba a spotřeba</h2>
        <div class="grid grid-cols-2 gap-2">
          <div class="info-box bg-blue-light">
            <div class="info-label">Celková výroba</div>
            <div class="info-value" id="total-production">1 447 078,00 kWh</div>
          </div>
          <div class="info-box bg-red-light">
            <div class="info-label">Celková spotřeba</div>
            <div class="info-value" id="total-consumption">1 925 474,50 kWh</div>
          </div>
          <div class="info-box bg-green-light">
            <div class="info-label">Vlastní spotřeba</div>
            <div class="info-value" id="self-consumption">1 192 101,25 kWh</div>
          </div>
          <div class="info-box bg-yellow-light">
            <div class="info-label">Přetoky do sítě</div>
            <div class="info-value" id="total-export">254 976,75 kWh</div>
          </div>
        </div>
      </div>
      
      <!-- Vlastní spotřeba -->
      <div class="card">
        <h2 class="card-title">Vlastní spotřeba</h2>
        <div class="grid grid-cols-2 gap-2">
          <div class="info-box bg-blue-light">
            <div class="info-label">Aktuální poměr</div>
            <div class="info-value" id="current-ratio">82,38%</div>
          </div>
          <div class="info-box bg-green-light">
            <div class="info-label">Požadovaný poměr</div>
            <div class="info-value">85,00%</div>
          </div>
          <div class="info-box bg-orange-light">
            <div class="info-label">Min. počet minerů</div>
            <div class="info-value" id="required-miners">4</div>
          </div>
          <div class="info-box bg-purple-light">
            <div class="info-label">Dotace v ohrožení</div>
            <div class="info-value">3 000 000 Kč</div>
          </div>
        </div>
      </div>
      
      <!-- Nastavení minerů a BESS -->
      <div class="card">
        <h2 class="card-title">Nastavení</h2>
        <div class="mb-3">
          <label class="block text-sm mb-1">Počet Antminer S19 Pro Hydro</label>
          <input
            type="range"
            min="0"
            max="20"
            value="4"
            id="miner-slider"
            class="w-full"
          />
          <div class="flex justify-between text-xs">
            <span>0</span>
            <span id="current-miners">4</span>
            <span>20</span>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="block text-sm mb-1">Počet OPTIM US L260-OMNI</label>
          <input
            type="range"
            min="0"
            max="5"
            value="2"
            id="bess-slider"
            class="w-full"
          />
          <div class="flex justify-between text-xs">
            <span>0</span>
            <span id="current-bess">2</span>
            <span>5</span>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-2 mt-4">
          <div class="info-box bg-amber-light">
            <div class="info-label">Miner: 5.428 kW</div>
            <div class="info-value">42 990 Kč</div>
          </div>
          <div class="info-box bg-violet-light">
            <div class="info-label">BESS: 260 kWh</div>
            <div class="info-value">1 625 000 Kč</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Výsledky optimalizace -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <!-- Energetické toky -->
      <div class="card">
        <h2 class="card-title" id="energy-flows-title">Energetické toky s 4 minery a 2 BESS</h2>
        <div class="grid grid-cols-2 gap-3">
          <div class="info-box bg-amber-light">
            <div class="info-label">Spotřeba minerů</div>
            <div class="info-value" id="miner-energy-used">40 138,70 kWh</div>
          </div>
          <div class="info-box bg-violet-light">
            <div class="info-label">Využití BESS</div>
            <div class="info-value" id="bess-energy-used">165 320,50 kWh</div>
          </div>
          <div class="info-box bg-yellow-light">
            <div class="info-label">Zbývající přetoky</div>
            <div class="info-value" id="remaining-export">49 517,55 kWh</div>
          </div>
          <div class="info-box bg-blue-light">
            <div class="info-label">Nový poměr VS</div>
            <div class="info-value" id="new-ratio">96,58%</div>
          </div>
          <div class="info-box bg-orange-light">
            <div class="info-label">Provoz minerů</div>
            <div class="info-value" id="hours-operation">2 035,50 h</div>
          </div>
          <div class="info-box bg-purple-light">
            <div class="info-label">Cykly BESS</div>
            <div class="info-value" id="bess-cycles">354,25</div>
          </div>
        </div>
      </div>
      
      <!-- Ekonomická analýza -->
      <div class="card">
        <h2 class="card-title">Ekonomická analýza</h2>
        <div class="grid grid-cols-2 gap-3">
          <div class="info-box bg-red-light">
            <div class="info-label">Investice do minerů</div>
            <div class="info-value" id="miner-investment">171 960 Kč</div>
          </div>
          <div class="info-box bg-red-light">
            <div class="info-label">Investice do BESS</div>
            <div class="info-value" id="bess-investment">5 000 000 Kč</div>
          </div>
          <div class="info-box bg-orange-light">
            <div class="info-label">Využití minerů</div>
            <div class="info-value" id="miner-utilization">23,24%</div>
          </div>
          <div class="info-box bg-orange-light">
            <div class="info-label">Využití BESS</div>
            <div class="info-value" id="bess-utilization">75,50%</div>
          </div>
          <div class="info-box bg-green-light">
            <div class="info-label">Měsíční výnos</div>
            <div class="info-value" id="monthly-income">60 994,08 Kč</div>
          </div>
          <div class="info-box bg-green-light">
            <div class="info-label">Roční výnos</div>
            <div class="info-value" id="yearly-income">731 929,00 Kč</div>
          </div>
          <div class="info-box bg-blue-light col-span-2">
            <div class="info-label">Návratnost investice</div>
            <div class="info-value" id="payback-years">7,08 let</div>
          </div>
        </div>
        
        <div class="mt-3 p-3 bg-indigo-light rounded">
          <div class="text-sm font-semibold mb-1">Srovnání s dotací:</div>
          <div class="flex items-center">
            <div class="text-lg font-bold text-red-600" id="comparison-result">NEVÝHODNÉ</div>
            <div class="ml-2" id="comparison-detail">(rozdíl 2 171 960 Kč navíc)</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Grafy -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- Analýza vlivu počtu minerů a BESS -->
      <div class="card">
        <h2 class="card-title">Analýza vlivu počtu minerů a BESS</h2>
        <div class="chart-container">
          <canvas id="impact-chart"></canvas>
        </div>
      </div>
      
      <!-- Rozložení spotřeby -->
      <div class="card">
        <h2 class="card-title">Rozložení spotřeby před a po optimalizaci</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="text-center text-sm font-medium mb-2">Před optimalizací</h3>
            <div class="pie-chart-container">
              <canvas id="before-chart"></canvas>
            </div>
          </div>
          <div>
            <h3 class="text-center text-sm font-medium mb-2" id="after-pie-title">Po optimalizaci (4 minerů, 2 BESS)</h3>
            <div class="pie-chart-container">
              <canvas id="after-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Distribuce přetoků -->
    <div class="card mb-6">
      <h2 class="card-title">Distribuce přetoků do sítě</h2>
      <div class="chart-container">
        <canvas id="distribution-chart"></canvas>
      </div>
    </div>
    
    <!-- Závěry a doporučení -->
    <div class="card">
      <h2 class="card-title">Závěry a doporučení</h2>
      
      <div class="space-y-4">
        <div>
          <h3 class="font-medium">Současný stav:</h3>
          <p>
            Aktuální poměr vlastní spotřeby je <span class="font-semibold">82,38%</span>, 
            což nesplňuje podmínku 85% pro zachování dotace.
          </p>
        </div>
        
        <div>
          <h3 class="font-medium">Optimální řešení:</h3>
          <p>
            Pro dosažení minimálně 85% vlastní spotřeby existuje několik možností:
          </p>
          <ul class="list-disc pl-5 mt-2 space-y-1">
            <li>Použití pouze minerů: minimálně <span class="font-semibold">4</span> minerů</li>
            <li>Použití pouze BESS: minimálně <span class="font-semibold">1</span> jednotka</li>
            <li>Optimální kombinace: <span class="font-semibold" id="optimal-miners">4</span> minerů a <span class="font-semibold" id="optimal-bess">0</span> BESS jednotek</li>
          </ul>
        </div>
        
        <div>
          <h3 class="font-medium">Ekonomické zhodnocení:</h3>
          <p id="economic-evaluation">
            Vybraná konfigurace (<span id="summary-miners-count">4</span> minerů a <span id="summary-bess-count">2</span> BESS jednotek) 
            vyžaduje investici <span class="font-semibold" id="summary-investment">5 171 960 Kč</span>, 
            což je výrazně více než potenciální ztráta dotace (3 000 000 Kč).
          </p>
          <p class="mt-1">
            Minery budou v provozu pouze během přetoků, přibližně <span class="font-semibold" id="summary-miner-utilization">23,24%</span> času v roce. 
            BESS jednotky budou využity na <span class="font-semibold" id="summary-bess-utilization">75,50%</span> své kapacity ročně.
          </p>
          <p class="mt-1">
            Odhadovaná návratnost celkové investice je přibližně <span class="font-semibold" id="summary-payback">7,08</span> let 
            z kombinace výnosů těžby a úspory energie z BESS.
          </p>
        </div>
        
        <div>
          <h3 class="font-medium">Energetické využití:</h3>
          <p>
            Při instalaci <span id="energy-miners-count">4</span> minerů a <span id="energy-bess-count">2</span> BESS jednotek by bylo 
            spotřebováno <span class="font-semibold" id="energy-total-used">205 459,20</span> kWh 
            přebytků energie ročně, což představuje <span class="font-semibold" id="energy-percentage">80,58%</span> 
            současných přetoků do sítě.
          </p>
        </div>
        
        <div id="recommendation-box" class="bg-green-light p-3 rounded">
          <h3 class="font-medium text-green-800">Finální doporučení:</h3>
          <p class="text-green-800" id="final-recommendation">
            Aktuální konfigurace (4 minerů a 2 BESS) dosahuje požadovaného poměru vlastní spotřeby 96,58%, což splňuje podmínku 85% pro zachování dotace.
            Z ekonomického hlediska je však tato varianta nevýhodná z důvodu vysokých investičních nákladů.
            Doporučujeme optimální konfiguraci: 4 minerů a 0 BESS jednotek s celkovou investicí 171 960 Kč, což je výrazně méně než hodnota dotace.
          </p>
        </div>
      </div>
    </div>
    
    <div class="text-center text-sm text-gray-500 mt-6">
      <p>Simulátor optimalizace FVE pomocí těžby kryptoměn a BESS | © 2025</p>
    </div>
  </div>

  <script>
    // Čekáme, až se knihovny načtou
    window.addEventListener('load', function() {
      // Funkce pro formátování čísel
      function formatNumber(num, decimals = 2) {
        if (num === undefined || num === null) {
          return '0';
        }
        try {
          return num.toLocaleString('cs-CZ', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
          });
        } catch (error) {
          console.error('Error formatting number:', error);
          return '0';
        }
      }
      
      // Předpřipravená data pro simulátor
      const simulationData = {
        totalProduction: 1447078.00,
        totalConsumption: 1925474.50,
        totalExport: 254976.75,
        selfConsumption: 1192101.25,
        selfConsumptionRatio: 82.38,
        
        // Parametry minerů
        minerPower: 5.428, // kW
        minerPrice: 42990, // Kč bez DPH
        minerMonthlyIncome: 274, // $ měsíčně
        exchangeRate: 25, // Kurz USD/CZK
        
        // Parametry BESS
        bessUnitCapacity: 260, // kWh
        bessUnitPower: 125, // kW
        bessUnitPrice: 1625000, // Kč (1 250 000 za jednotku + 375 000 montáž a příslušenství)
        bessEfficiency: 0.95, // 95% účinnost
        bessMinSOC: 0.1, // Minimální stav nabití 10%
        bessMaxSOC: 0.9, // Maximální stav nabití 90%
        bessPricePerKWh: 4, // Kč za kWh (výdělek z arbitráže)
        
        // Předpočítané hodnoty pro různé počty minerů
        minerResults: {
          0: { energyUsed: 0, utilizationRatio: 0, newSelfConsumptionRatio: 82.38 },
          1: { energyUsed: 11048.69, utilizationRatio: 23.24, newSelfConsumptionRatio: 83.14 },
          2: { energyUsed: 21334.75, utilizationRatio: 23.24, newSelfConsumptionRatio: 83.85 },
          3: { energyUsed: 30977.60, utilizationRatio: 23.24, newSelfConsumptionRatio: 84.52 },
          4: { energyUsed: 40138.70, utilizationRatio: 23.24, newSelfConsumptionRatio: 85.15 },
          5: { energyUsed: 48796.36, utilizationRatio: 23.24, newSelfConsumptionRatio: 85.75 },
          6: { energyUsed: 57037.42, utilizationRatio: 23.24, newSelfConsumptionRatio: 86.32 },
          7: { energyUsed: 64760.11, utilizationRatio: 23.24, newSelfConsumptionRatio: 86.86 },
          8: { energyUsed: 71956.28, utilizationRatio: 23.24, newSelfConsumptionRatio: 87.35 },
          9: { energyUsed: 78725.00, utilizationRatio: 23.24, newSelfConsumptionRatio: 87.82 },
          10: { energyUsed: 85022.84, utilizationRatio: 23.24, newSelfConsumptionRatio: 88.26 },
          11: { energyUsed: 90846.77, utilizationRatio: 23.24, newSelfConsumptionRatio: 88.68 },
          12: { energyUsed: 96142.59, utilizationRatio: 23.24, newSelfConsumptionRatio: 89.06 },
          13: { energyUsed: 100924.16, utilizationRatio: 23.24, newSelfConsumptionRatio: 89.40 },
          14: { energyUsed: 105205.36, utilizationRatio: 23.24, newSelfConsumptionRatio: 89.71 },
          15: { energyUsed: 108999.02, utilizationRatio: 23.24, newSelfConsumptionRatio: 89.98 },
          16: { energyUsed: 112305.58, utilizationRatio: 23.24, newSelfConsumptionRatio: 90.20 },
          17: { energyUsed: 115158.45, utilizationRatio: 23.24, newSelfConsumptionRatio: 90.40 },
          18: { energyUsed: 117558.53, utilizationRatio: 23.24, newSelfConsumptionRatio: 90.57 },
          19: { energyUsed: 119588.52, utilizationRatio: 23.24, newSelfConsumptionRatio: 90.71 },
          20: { energyUsed: 121297.73, utilizationRatio: 23.24, newSelfConsumptionRatio: 90.83 }
        },
        
        // Předpočítané hodnoty pro různé počty BESS
        bessResults: {
          0: { energyCharged: 0, energyDischarged: 0, utilizationRatio: 0, newSelfConsumptionRatio: 82.38, chargeCycles: 0 },
          1: { energyCharged: 114550.25, energyDischarged: 108822.74, utilizationRatio: 80.65, newSelfConsumptionRatio: 89.90, chargeCycles: 490.51 },
          2: { energyCharged: 169140.75, energyDischarged: 160683.71, utilizationRatio: 75.50, newSelfConsumptionRatio: 93.48, chargeCycles: 354.25 },
          3: { energyCharged: 198736.85, energyDischarged: 188799.96, utilizationRatio: 62.35, newSelfConsumptionRatio: 95.43, chargeCycles: 283.33 },
          4: { energyCharged: 220138.25, energyDischarged: 209131.34, utilizationRatio: 49.25, newSelfConsumptionRatio: 96.83, chargeCycles: 235.15 },
          5: { energyCharged: 235765.52, energyDischarged: 223977.25, utilizationRatio: 40.42, newSelfConsumptionRatio: 97.86, chargeCycles: 201.51 }
        },
        
        // Kombinované hodnoty pro minery a BESS
        combinedResults: {},
        
        // Data pro distribuci přetoků
        exportDistribution: [
          {pretok: 1, cetnost: 484, hodiny: 121.0},
          {pretok: 5, cetnost: 127, hodiny: 31.8},
          {pretok: 10, cetnost: 95, hodiny: 23.8},
          {pretok: 15, cetnost: 72, hodiny: 18.0},
          {pretok: 20, cetnost: 67, hodiny: 16.8},
          {pretok: 25, cetnost: 63, hodiny: 15.8},
          {pretok: 30, cetnost: 61, hodiny: 15.3},
          {pretok: 35, cetnost: 52, hodiny: 13.0},
          {pretok: 40, cetnost: 47, hodiny: 11.8},
          {pretok: 45, cetnost: 42, hodiny: 10.5},
          {pretok: 50, cetnost: 38, hodiny: 9.5},
          {pretok: 60, cetnost: 35, hodiny: 8.8},
          {pretok: 70, cetnost: 32, hodiny: 8.0},
          {pretok: 80, cetnost: 24, hodiny: 6.0},
          {pretok: 90, cetnost: 18, hodiny: 4.5},
          {pretok: 100, cetnost: 13, hodiny: 3.3}
        ]
      };
      
      // Předpočítání hodnot pro kombinované využití minerů a BESS
      function simulateCombination(numMiners, numBessUnits) {
        const minerData = simulationData.minerResults[numMiners] || { energyUsed: 0, utilizationRatio: 0, newSelfConsumptionRatio: simulationData.selfConsumptionRatio };
        const bessData = simulationData.bessResults[numBessUnits] || { energyCharged: 0, energyDischarged: 0, utilizationRatio: 0, newSelfConsumptionRatio: simulationData.selfConsumptionRatio, chargeCycles: 0 };
        
        // Zbývající přetoky po odběru minerů
        const remainingExportAfterMiners = simulationData.totalExport - minerData.energyUsed;
        
        // Koeficient využitelnosti BESS (jak moc může BESS využít zbývající přetoky ve srovnání s maximem)
        const bessUtilizationFactor = Math.min(1, remainingExportAfterMiners / simulationData.totalExport);
        
        // Upravené využití BESS s ohledem na zbývající přetoky
        const adjustedBessEnergyCharged = bessData.energyCharged * bessUtilizationFactor;
        const adjustedBessEnergyDischarged = bessData.energyDischarged * bessUtilizationFactor;
        const adjustedBessChargeCycles = bessData.chargeCycles * bessUtilizationFactor;
        
        // Příspěvek minerů i BESS k vlastní spotřebě
        const combinedSelfConsumptionRatio = (
          (simulationData.selfConsumption + minerData.energyUsed + adjustedBessEnergyDischarged) / 
          simulationData.totalProduction * 100
        );
        
        // Zbývající přetoky po odběru minerů i BESS
        const remainingExport = simulationData.totalExport - minerData.energyUsed - adjustedBessEnergyCharged;
        
        // Ekonomická analýza
        const minerInvestment = numMiners * simulationData.minerPrice;
        const bessInvestment = numBessUnits * simulationData.bessUnitPrice;
        const totalInvestment = minerInvestment + bessInvestment;
        
        // Výnosy z těžby
        const yearlyMiningIncome = numMiners * simulationData.minerMonthlyIncome * simulationData.exchangeRate * (minerData.utilizationRatio / 100) * 12;
        
        // Výnosy z BESS
        const yearlyBessIncome = adjustedBessEnergyDischarged * simulationData.bessPricePerKWh;
        
        // Celkové výnosy a návratnost
        const yearlyIncome = yearlyMiningIncome + yearlyBessIncome;
        const paybackYears = yearlyIncome > 0 ? totalInvestment / yearlyIncome : Infinity;
        
        return {
          minerEnergyUsed: minerData.energyUsed,
          bessEnergyCharged: adjustedBessEnergyCharged,
          bessEnergyDischarged: adjustedBessEnergyDischarged,
          combinedSelfConsumptionRatio,
          remainingExport,
          minerUtilizationRatio: minerData.utilizationRatio,
          bessUtilizationRatio: bessData.utilizationRatio * bessUtilizationFactor,
          bessChargeCycles: adjustedBessChargeCycles,
          minerInvestment,
          bessInvestment,
          totalInvestment,
          yearlyMiningIncome,
          yearlyBessIncome,
          monthlyIncome: yearlyIncome / 12,
          yearlyIncome,
          paybackYears
        };
      }
      
      // Předpočítání všech kombinací
      for (let m = 0; m <= 20; m++) {
        simulationData.combinedResults[m] = {};
        for (let b = 0; b <= 5; b++) {
          simulationData.combinedResults[m][b] = simulateCombination(m, b);
        }
      }
      
      // Najít optimální kombinaci pro splnění 85% vlastní spotřeby
      function findOptimalCombination() {
        let minInvestment = Infinity;
        let optimalMiners = 0;
        let optimalBess = 0;
        
        for (let m = 0; m <= 20; m++) {
          for (let b = 0; b <= 5; b++) {
            const combo = simulationData.combinedResults[m][b];
            if (combo.combinedSelfConsumptionRatio >= 85) {
              if (combo.totalInvestment < minInvestment) {
                minInvestment = combo.totalInvestment;
                optimalMiners = m;
                optimalBess = b;
              }
            }
          }
        }
        
        return {
          optimalMiners,
          optimalBess,
          optimalInvestment: minInvestment
        };
      }
      
      const optimalCombination = findOptimalCombination();
      
      // Aktualizace UI podle stavu sliderů
      function updateUI() {
        const numMiners = parseInt(document.getElementById('miner-slider').value);
        const numBessUnits = parseInt(document.getElementById('bess-slider').value);
        
        // Aktualizace zobrazovaných hodnot
        document.getElementById('current-miners').textContent = numMiners;
        document.getElementById('current-bess').textContent = numBessUnits;
        
        // Získání dat pro aktuální kombinaci
        const currentCombo = simulationData.combinedResults[numMiners][numBessUnits];
        
        // Aktualizace nadpisů
        document.getElementById('energy-flows-title').textContent = `Energetické toky s ${numMiners} minery a ${numBessUnits} BESS`;
        document.getElementById('after-pie-title').textContent = `Po optimalizaci (${numMiners} minerů, ${numBessUnits} BESS)`;
        
        // Aktualizace energetických toků
        document.getElementById('miner-energy-used').textContent = `${formatNumber(currentCombo.minerEnergyUsed)} kWh`;
        document.getElementById('bess-energy-used').textContent = `${formatNumber(currentCombo.bessEnergyDischarged)} kWh`;
        document.getElementById('remaining-export').textContent = `${formatNumber(currentCombo.remainingExport)} kWh`;
        document.getElementById('new-ratio').textContent = `${formatNumber(currentCombo.combinedSelfConsumptionRatio)}%`;
        document.getElementById('hours-operation').textContent = `${formatNumber(numMiners > 0 ? 2035.5 : 0)} h`;
        document.getElementById('bess-cycles').textContent = `${formatNumber(currentCombo.bessChargeCycles)}`;
        
        // Aktualizace ekonomické analýzy
        document.getElementById('miner-investment').textContent = `${formatNumber(currentCombo.minerInvestment)} Kč`;
        document.getElementById('bess-investment').textContent = `${formatNumber(currentCombo.bessInvestment)} Kč`;
        document.getElementById('miner-utilization').textContent = `${formatNumber(currentCombo.minerUtilizationRatio)}%`;
        document.getElementById('bess-utilization').textContent = `${formatNumber(currentCombo.bessUtilizationRatio)}%`;
        document.getElementById('monthly-income').textContent = `${formatNumber(currentCombo.monthlyIncome)} Kč`;
        document.getElementById('yearly-income').textContent = `${formatNumber(currentCombo.yearlyIncome)} Kč`;
        document.getElementById('payback-years').textContent = `${formatNumber(currentCombo.paybackYears)} let`;
        
        // Srovnání s dotací
        const dotation = 3000000;
        const comparison = dotation - currentCombo.totalInvestment;
        const isPositive = comparison > 0;
        
        document.getElementById('comparison-result').textContent = isPositive ? 'VÝHODNÉ' : 'NEVÝHODNÉ';
        document.getElementById('comparison-result').className = `text-lg font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}`;
        document.getElementById('comparison-detail').textContent = `(rozdíl ${formatNumber(Math.abs(comparison))} Kč ${isPositive ? 'úspora' : 'navíc'})`;
        
        // Aktualizace hodnot v závěrech
        document.getElementById('summary-miners-count').textContent = numMiners;
        document.getElementById('summary-bess-count').textContent = numBessUnits;
        document.getElementById('summary-investment').textContent = `${formatNumber(currentCombo.totalInvestment)} Kč`;
        document.getElementById('summary-miner-utilization').textContent = `${formatNumber(currentCombo.minerUtilizationRatio)}%`;
        document.getElementById('summary-bess-utilization').textContent = `${formatNumber(currentCombo.bessUtilizationRatio)}%`;
        document.getElementById('summary-payback').textContent = `${formatNumber(currentCombo.paybackYears)}`;
        document.getElementById('energy-miners-count').textContent = numMiners;
        document.getElementById('energy-bess-count').textContent = numBessUnits;
        document.getElementById('energy-total-used').textContent = `${formatNumber(currentCombo.minerEnergyUsed + currentCombo.bessEnergyDischarged)}`;
        document.getElementById('energy-percentage').textContent = `${formatNumber((currentCombo.minerEnergyUsed + currentCombo.bessEnergyCharged) / simulationData.totalExport * 100)}%`;
        
        // Aktualizace optimální kombinace
        document.getElementById('optimal-miners').textContent = optimalCombination.optimalMiners;
        document.getElementById('optimal-bess').textContent = optimalCombination.optimalBess;
        
        // Aktualizace doporučení
        if (currentCombo.combinedSelfConsumptionRatio >= 85) {
          if (currentCombo.totalInvestment <= dotation) {
            document.getElementById('recommendation-box').className = 'bg-green-light p-3 rounded';
            document.getElementById('final-recommendation').className = 'text-green-800';
            document.getElementById('final-recommendation').textContent = `Aktuální konfigurace (${numMiners} minerů a ${numBessUnits} BESS) dosahuje požadovaného poměru vlastní spotřeby ${formatNumber(currentCombo.combinedSelfConsumptionRatio)}%, což splňuje podmínku 85% pro zachování dotace. Tato konfigurace je ekonomicky výhodná s návratností ${formatNumber(currentCombo.paybackYears)} let.`;
          } else {
            document.getElementById('recommendation-box').className = 'bg-yellow-light p-3 rounded';
            document.getElementById('final-recommendation').className = 'text-orange-800';
            document.getElementById('final-recommendation').textContent = `Aktuální konfigurace (${numMiners} minerů a ${numBessUnits} BESS) dosahuje požadovaného poměru vlastní spotřeby ${formatNumber(currentCombo.combinedSelfConsumptionRatio)}%, což splňuje podmínku 85% pro zachování dotace. Z ekonomického hlediska je však tato varianta nevýhodná z důvodu vysokých investičních nákladů. Doporučujeme optimální konfiguraci: ${optimalCombination.optimalMiners} minerů a ${optimalCombination.optimalBess} BESS jednotek s celkovou investicí ${formatNumber(optimalCombination.optimalInvestment)} Kč, což je výrazně méně než hodnota dotace.`;
          }
        } else {
          document.getElementById('recommendation-box').className = 'bg-red-light p-3 rounded';
          document.getElementById('final-recommendation').className = 'text-red-800';
          document.getElementById('final-recommendation').textContent = `Aktuální konfigurace (${numMiners} minerů a ${numBessUnits} BESS) dosahuje poměru vlastní spotřeby pouze ${formatNumber(currentCombo.combinedSelfConsumptionRatio)}%, což NESPLŇUJE podmínku 85% pro zachování dotace. Pro dosažení požadovaného poměru doporučujeme optimální konfiguraci: ${optimalCombination.optimalMiners} minerů a ${optimalCombination.optimalBess} BESS jednotek s celkovou investicí ${formatNumber(optimalCombination.optimalInvestment)} Kč.`;
        }
        
        // Aktualizace koláčových grafů
        if (afterChart) {
          afterChart.data.datasets[0].data = [
            simulationData.selfConsumption,
            currentCombo.minerEnergyUsed,
            currentCombo.bessEnergyDischarged,
            currentCombo.remainingExport
          ];
          afterChart.update();
        }
      }
      
      // Inicializace grafů
      function initCharts() {
        // Graf vlivu počtu minerů a BESS
        const ctx1 = document.getElementById('impact-chart').getContext('2d');
        
        // Příprava dat pro graf
        const minerLabels = Array.from({ length: 21 }, (_, i) => i);
        const minerSelfConsumptionData = minerLabels.map(m => simulationData.minerResults[m].newSelfConsumptionRatio);
        const minerEnergyUsedData = minerLabels.map(m => simulationData.minerResults[m].energyUsed / 1000);
        
        const bessLabels = Array.from({ length: 6 }, (_, i) => i);
        const bessSelfConsumptionData = bessLabels.map(b => simulationData.bessResults[b].newSelfConsumptionRatio);
        const bessEnergyUsedData = bessLabels.map(b => simulationData.bessResults[b].energyDischarged / 1000);
        
        const impactChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: minerLabels,
            datasets: [
              {
                label: 'VS s minery (%)',
                data: minerSelfConsumptionData,
                borderColor: '#8884d8',
                backgroundColor: 'rgba(136, 132, 216, 0.2)',
                yAxisID: 'y',
                tension: 0.3
              },
              {
                label: 'VS s BESS (%)',
                data: [
                  bessSelfConsumptionData[0],
                  bessSelfConsumptionData[1],
                  bessSelfConsumptionData[2],
                  bessSelfConsumptionData[3],
                  bessSelfConsumptionData[4],
                  bessSelfConsumptionData[5],
                  null, null, null, null, null, null, null, null, null, null, null, null, null, null, null
                ],
                borderColor: '#0088FE',
                backgroundColor: 'rgba(0, 136, 254, 0.2)',
                yAxisID: 'y',
                tension: 0.3
              },
              {
                label: 'Spotřeba minerů (MWh)',
                data: minerEnergyUsedData,
                borderColor: '#82ca9d',
                backgroundColor: 'rgba(130, 202, 157, 0.2)',
                yAxisID: 'y1',
                tension: 0.3
              },
              {
                label: 'Využití BESS (MWh)',
                data: [
                  bessEnergyUsedData[0],
                  bessEnergyUsedData[1],
                  bessEnergyUsedData[2],
                  bessEnergyUsedData[3],
                  bessEnergyUsedData[4],
                  bessEnergyUsedData[5],
                  null, null, null, null, null, null, null, null, null, null, null, null, null, null, null
                ],
                borderColor: '#FF8042',
                backgroundColor: 'rgba(255, 128, 66, 0.2)',
                yAxisID: 'y1',
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Poměr vlastní spotřeby (%)'
                },
                min: 80,
                max: 100
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Spotřeba (MWh)'
                },
                grid: {
                  drawOnChartArea: false
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y.toFixed(2);
                      if (context.dataset.yAxisID === 'y') {
                        label += '%';
                      } else {
                        label += ' MWh';
                      }
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
        
        // Koláčový graf před optimalizací
        const ctx2 = document.getElementById('before-chart').getContext('2d');
        const beforeChart = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Vlastní spotřeba', 'Přetoky do sítě'],
            datasets: [{
              data: [simulationData.selfConsumption, simulationData.totalExport],
              backgroundColor: ['#0088FE', '#00C49F'],
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    const total = simulationData.selfConsumption + simulationData.totalExport;
                    const percentage = (value / total * 100).toFixed(1);
                    return `${context.label}: ${formatNumber(value)} kWh (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
        
        // Koláčový graf po optimalizaci
        const ctx3 = document.getElementById('after-chart').getContext('2d');
        const numMiners = parseInt(document.getElementById('miner-slider').value);
        const numBessUnits = parseInt(document.getElementById('bess-slider').value);
        const currentCombo = simulationData.combinedResults[numMiners][numBessUnits];
        
        window.afterChart = new Chart(ctx3, {
          type: 'doughnut',
          data: {
            labels: ['Vlastní spotřeba', 'Spotřeba minerů', 'Využití BESS', 'Zbývající přetoky'],
            datasets: [{
              data: [
                simulationData.selfConsumption,
                currentCombo.minerEnergyUsed,
                currentCombo.bessEnergyDischarged,
                currentCombo.remainingExport
              ],
              backgroundColor: ['#0088FE', '#00C49F', '#8884d8', '#FFBB28'],
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    const total = simulationData.totalProduction;
                    const percentage = (value / total * 100).toFixed(1);
                    return `${context.label}: ${formatNumber(value)} kWh (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
        
        // Graf distribuce přetoků
        const ctx4 = document.getElementById('distribution-chart').getContext('2d');
        const distributionChart = new Chart(ctx4, {
          type: 'bar',
          data: {
            labels: simulationData.exportDistribution.map(item => item.pretok),
            datasets: [{
              label: 'Počet čtvrthodin',
              data: simulationData.exportDistribution.map(item => item.cetnost),
              backgroundColor: 'rgba(136, 132, 216, 0.7)',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Velikost přetoku (kW)'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Počet čtvrthodin'
                },
                beginAtZero: true
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const index = context.dataIndex;
                    const cetnost = simulationData.exportDistribution[index].cetnost;
                    const hodiny = simulationData.exportDistribution[index].hodiny;
                    return [
                      `Četnost: ${cetnost} čtvrthodin`,
                      `Doba trvání: ${formatNumber(hodiny)} hodin`
                    ];
                  }
                }
              }
            }
          }
        });
      }
      
      // Nastavení posluchačů událostí
      document.getElementById('miner-slider').addEventListener('input', updateUI);
      document.getElementById('bess-slider').addEventListener('input', updateUI);
      
      // Inicializace stránky
      initCharts();
      updateUI();
      
      // Skrytí loading obrazovky
      document.getElementById('loading').style.display = 'none';
    });
  </script>
</body>
</html>
